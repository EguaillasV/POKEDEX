{% extends 'base.html' %}

{% block title %}Cambiar Contraseña - Animal Recognition{% endblock %}

{% block extra_css %}
<style>
    /* Ocultar todos los iconos nativos del navegador en inputs de contraseña */
    /* Chrome, Safari */
    input[type="password"]::-webkit-textfield-decoration-container {
        display: none !important;
    }
    
    input[type="password"]::-webkit-reveal {
        display: none !important;
    }
    
    /* Edge, Explorer */
    input[type="password"]::-ms-reveal {
        display: none !important;
    }
    
    input[type="password"]::-ms-password-reveal {
        display: none !important;
    }
    
    /* Asegurar que no haya espacio para el icono nativo */
    input[type="password"] {
        padding-right: 12px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-12 px-4">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl card-shadow overflow-hidden">

        <!-- Header con ícono -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 text-center">
            <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                <img src="https://img.icons8.com/pulsar-color/48/key.png" alt="key" class="w-12 h-12">
            </div>
            <h1 class="text-2xl font-bold mb-2">Cambiar Contraseña</h1>
            <p class="text-blue-100 text-sm">Actualiza tu contraseña de seguridad</p>
        </div>

        <!-- Contenido -->
        <div class="p-8">

            <!-- Mensajes de error/éxito -->
            {% if error_message %}
                <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-8">
                    <div class="flex items-start gap-3">
                        <img src="https://img.icons8.com/color/32/delete-sign.png" alt="error" class="w-5 h-5 mt-1 flex-shrink-0">
                        <div>
                            <p class="text-red-800 text-sm font-semibold">Error</p>
                            <p class="text-red-700 text-sm mt-1">{{ error_message }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if messages %}
                {% for message in messages %}
                    {% if message.tags == 'success' %}
                        <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4 mb-8">
                            <div class="flex items-start gap-3">
                                <img src="https://img.icons8.com/color/32/checkmark.png" alt="success" class="w-5 h-5 mt-1 flex-shrink-0">
                                <div>
                                    <p class="text-green-800 text-sm font-semibold">Éxito</p>
                                    <p class="text-green-700 text-sm mt-1">{{ message }}</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <!-- Nota informativa -->
            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 mb-8">
                <div class="flex items-start gap-3">
                    <img src="https://img.icons8.com/color/32/info.png" alt="info" class="w-5 h-5 mt-1 flex-shrink-0">
                    <p class="text-blue-800 text-sm">
                        Tu contraseña debe tener al menos 8 caracteres e incluir mayúsculas, minúsculas, números y
                        símbolos para mayor seguridad.
                    </p>
                </div>
            </div>

            <!-- Formulario -->
            <form method="post" class="space-y-6" id="change-password-form">
                {% csrf_token %}

                <!-- Contraseña Actual -->
                <div>
                    <label for="current_password" class="block text-gray-700 font-semibold text-sm mb-3">
                        Contraseña Actual
                    </label>
                    <div class="relative">
                        <input type="password" id="current_password" name="current_password" placeholder="Ingrese su contraseña actual"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                        <button type="button" class="toggle-password absolute right-3 top-3 text-gray-500 hover:text-gray-700" data-target="current_password">
                            <img src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="show" class="w-6 h-6">
                        </button>
                    </div>
                </div>

                <!-- Nueva Contraseña -->
                <div>
                    <label for="new_password" class="block text-gray-700 font-semibold text-sm mb-3">
                        Nueva Contraseña
                    </label>
                    <div class="relative">
                        <input type="password" id="new_password" name="new_password" placeholder="Ingrese su nueva contraseña"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                        <button type="button" class="toggle-password absolute right-3 top-3 text-gray-500 hover:text-gray-700" data-target="new_password">
                            <img src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="show" class="w-6 h-6">
                        </button>
                    </div>
                </div>

                <!-- Confirmar Contraseña -->
                <div>
                    <label for="confirm_password" class="block text-gray-700 font-semibold text-sm mb-3">
                        Confirmar Nueva Contraseña
                    </label>
                    <div class="relative">
                        <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirme su nueva contraseña"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                        <button type="button" class="toggle-password absolute right-3 top-3 text-gray-500 hover:text-gray-700" data-target="confirm_password">
                            <img src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="show" class="w-6 h-6">
                        </button>
                    </div>
                </div>

                <!-- Requisitos de contraseña -->
                <div class="bg-gray-50 rounded-lg p-5 mt-6">
                    <h3 class="text-gray-700 font-semibold text-sm mb-4">Requisitos de la contraseña:</h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <img id="req1" src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="visible" class="w-6 h-6 opacity-30 requirement-icon">
                            <label class="text-gray-600 text-sm">Al menos 8 caracteres</label>
                        </div>
                        <div class="flex items-center gap-3">
                            <img id="req2" src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="visible" class="w-6 h-6 opacity-30 requirement-icon">
                            <label class="text-gray-600 text-sm">Al menos una letra mayúscula</label>
                        </div>
                        <div class="flex items-center gap-3">
                            <img id="req3" src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="visible" class="w-6 h-6 opacity-30 requirement-icon">
                            <label class="text-gray-600 text-sm">Al menos una letra minúscula</label>
                        </div>
                        <div class="flex items-center gap-3">
                            <img id="req4" src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="visible" class="w-6 h-6 opacity-30 requirement-icon">
                            <label class="text-gray-600 text-sm">Al menos un número</label>
                        </div>
                        <div class="flex items-center gap-3">
                            <img id="req5" src="https://img.icons8.com/ios-glyphs/30/visible--v1.png" alt="visible" class="w-6 h-6 opacity-30 requirement-icon">
                            <label class="text-gray-600 text-sm">Al menos un símbolo especial
                                (!@#$%^&*)</label>
                        </div>
                    </div>
                </div>

                <!-- Alerta de coincidencia -->
                <div id="password-match-alert" class="hidden bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4">
                    <p class="text-yellow-800 text-sm font-semibold">Las contraseñas no coinciden</p>
                </div>

                <!-- Botones -->
                <div class="flex gap-4 mt-8 pt-6 border-t">
                    <a href="{% url 'gestion_cuenta' %}"
                        class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition flex items-center justify-center gap-2">
                        <img src="https://img.icons8.com/color/24/multiply.png" alt="cancel" class="w-5 h-5">
                        Cancelar
                    </a>
                    <button type="submit" id="submit-btn"
                        class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition flex items-center justify-center gap-2 opacity-50 cursor-not-allowed"
                        disabled>
                        <img src="https://img.icons8.com/color/24/checkmark--v1.png" alt="update" class="w-5 h-5">
                        Actualizar Contraseña
                    </button>
                </div>

            </form>

            <!-- Nota de seguridad -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4 mt-8">
                <div class="flex items-start gap-3">
                    <img src="https://img.icons8.com/color/32/security-checked.png" alt="security"
                        class="w-5 h-5 mt-1 flex-shrink-0">
                    <div>
                        <p class="text-yellow-800 text-sm font-semibold">Nota de Seguridad:</p>
                        <p class="text-yellow-700 text-sm mt-1">Después de cambiar la contraseña será desconectado de
                            todos los dispositivos excepto este. Tendrás que iniciar sesión nuevamente en otros
                            dispositivos.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Toggle mostrar/ocultar contraseña
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.dataset.target;
            const input = document.getElementById(targetId);
            const isPassword = input.type === 'password';
            
            input.type = isPassword ? 'text' : 'password';
        });
    });

    // Validación en tiempo real
    const newPasswordEl = document.getElementById('new_password');
    const confirmPasswordEl = document.getElementById('confirm_password');
    const currentPasswordEl = document.getElementById('current_password');
    const submitBtn = document.getElementById('submit-btn');
    const passwordMatchAlert = document.getElementById('password-match-alert');

    const requirements = {
        req1: { regex: /.{8,}/, id: 'req1' },
        req2: { regex: /[A-Z]/, id: 'req2' },
        req3: { regex: /[a-z]/, id: 'req3' },
        req4: { regex: /\d/, id: 'req4' },
        req5: { regex: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>/?]/, id: 'req5' }
    };

    function updateCheckboxes() {
        const password = newPasswordEl.value;
        
        Object.values(requirements).forEach(req => {
            const icon = document.getElementById(req.id);
            // Cambiar opacidad si coincide el requisito
            if (password.length > 0 && req.regex.test(password)) {
                icon.classList.remove('opacity-30');
                icon.classList.add('opacity-100');
            } else {
                icon.classList.remove('opacity-100');
                icon.classList.add('opacity-30');
            }
        });
    }

    function checkRequirements() {
        updateCheckboxes();
        
        const password = newPasswordEl.value;
        const confirmValue = confirmPasswordEl.value;
        const currentValue = currentPasswordEl.value;
        
        // Revisar si todos los requisitos están cumplidos
        let allMet = password.length > 0;
        Object.values(requirements).forEach(req => {
            if (!req.regex.test(password)) {
                allMet = false;
            }
        });

        // Validar coincidencia de contraseñas
        let passwordsMatch = false;
        if (password && confirmValue) {
            passwordsMatch = password === confirmValue;
            if (!passwordsMatch && confirmValue.length > 0) {
                passwordMatchAlert.classList.remove('hidden');
            } else {
                passwordMatchAlert.classList.add('hidden');
            }
        } else {
            passwordMatchAlert.classList.add('hidden');
        }

        // Habilitar botón si todo está bien
        const buttonEnabled = currentValue.length > 0 && password.length > 0 && confirmValue.length > 0 && allMet && passwordsMatch;
        
        if (buttonEnabled) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    // Event listeners
    newPasswordEl?.addEventListener('input', checkRequirements);
    confirmPasswordEl?.addEventListener('input', checkRequirements);
    currentPasswordEl?.addEventListener('input', checkRequirements);
    
    // Realizar validación inicial cuando carga la página
    window.addEventListener('load', checkRequirements);
</script>
{% endblock %}