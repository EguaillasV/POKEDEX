{% extends 'base.html' %}

{% block title %}Galería de Animales - Animal Recognition{% endblock %}

{% block content %}
<div data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2"><img src="https://img.icons8.com/windows/32/trophy.png" alt="galería" class="w-8 h-8"/>Galería de Animales</h1>
    <p class="text-gray-600">{% if user.is_authenticated %}Mis descubrimientos{% else %}Explora todos los animales que puedes descubrir con nuestra aplicación{% endif %}</p>
</div>

<!-- Filters -->
<div class="bg-white rounded-2xl card-shadow p-6 mb-8">
    <div class="flex flex-wrap gap-4 items-center">
        <div class="flex-1 min-w-64">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Buscar animales..." 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            >
        </div>
        <div class="flex gap-2 flex-wrap">
  <button class="filter-btn active px-4 py-2 rounded-lg bg-purple-600 text-white" data-class="all">
    Todos
  </button>

  <button class="filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200" data-class="MAMMAL">
    <img src="https://img.icons8.com/ios-filled/50/capybara.png" alt="capybara"
      class="inline-block w-6 h-6 mr-2" />
    Mamíferos
  </button>

  <button class="filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200" data-class="BIRD">
    <img src="https://img.icons8.com/ios-glyphs/30/owl.png" alt="owl"
      class="inline-block w-6 h-6 mr-2" />
    Aves
  </button>

  <button class="filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200" data-class="REPTILE">
    <img src="https://img.icons8.com/forma-bold-filled/24/lizard.png" alt="lizard"
      class="inline-block w-6 h-6 mr-2" />
    Reptiles
  </button>

  <button class="filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200" data-class="AMPHIBIAN">
    <img src="https://img.icons8.com/windows/24/frog.png" alt="frog"
      class="inline-block w-6 h-6 mr-2" />
    Anfibios
  </button>

  <button class="filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200" data-class="FISH">
    <img src="https://img.icons8.com/windows/24/fish.png" alt="peces"
      class="inline-block w-6 h-6 mr-2" />
    Peces
  </button>

  <button class="filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200" data-class="INVERTEBRATE">
    <img src="https://img.icons8.com/windows/24/butterfly.png" alt="invertebrado"
      class="inline-block w-6 h-6 mr-2" />
    Invertebrados
  </button>
</div>


<!-- Animals Grid -->
<div id="animals-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    <!-- Loading state -->
    <div id="loading-state" class="col-span-full text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
        <p class="text-gray-500">Cargando animales...</p>
    </div>
</div>

<!-- Empty state -->
<div id="empty-state" class="hidden text-center py-12">
  <div class="text-6xl mb-4">
    <img src="https://img.icons8.com/nolan/64/search-more.png" alt="search-more"
      class="w-16 h-16 mx-auto" />
  </div>

  <h3 class="text-xl font-semibold text-gray-700 mb-2">No se encontraron animales</h3>
  <p class="text-gray-500">Intenta con otro término de búsqueda</p>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    let allAnimals = [];
    let filteredAnimals = [];
    
    // Fetch animals on page load
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // If user is authenticated, load only user discoveries
            const userAuthenticated = document.querySelector('[data-user-authenticated]');
            let apiUrl = '/api/animals/';
            
            if (userAuthenticated && userAuthenticated.getAttribute('data-user-authenticated') === 'true') {
                apiUrl = '/api/animals/?user_only=true';
            }
            
            const response = await fetch(apiUrl);
            allAnimals = await response.json();
            filteredAnimals = [...allAnimals];
            renderAnimals();
        } catch (error) {
            console.error('Error fetching animals:', error);
            document.getElementById('loading-state').innerHTML = `
                <p class="text-red-500">Error al cargar animales</p>
            `;
        }
    });
    
    function renderAnimals() {
        const grid = document.getElementById('animals-grid');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        
        // Agregar estilos CSS para el manejo de imágenes rotas
        if (!document.getElementById('image-fallback-style')) {
            const style = document.createElement('style');
            style.id = 'image-fallback-style';
            style.textContent = `
                .show-emoji .animal-emoji {
                    display: flex !important;
                    align-items: center;
                    justify-content: center;
                }
            `;
            document.head.appendChild(style);
        }
        
        // Ocultar loading state solo si existe
        if (loadingState) {
            loadingState.classList.add('hidden');
        }
        
        if (filteredAnimals.length === 0) {
            if (emptyState) {
                emptyState.classList.remove('hidden');
            }
            grid.innerHTML = '';
            return;
        }
        
        if (emptyState) {
            emptyState.classList.add('hidden');
        }
        
        grid.innerHTML = filteredAnimals.map(animal => `
            <div class="discovery-card bg-white rounded-2xl card-shadow overflow-hidden cursor-pointer" onclick="viewAnimal('${animal.id}')">
                <div class="aspect-square bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center text-6xl">
                    ${animal.image_url ? `<img src="${animal.image_url}" alt="${animal.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.classList.add('show-emoji')"/>` : ''}<span class="animal-emoji">${getAnimalEmoji(animal.animal_class)}</span>
                </div>
                <div class="p-4">
                    <h3 class="font-bold text-gray-800 text-lg">${animal.name}</h3>
                    <p class="text-gray-500 text-sm italic">${animal.scientific_name}</p>
                    <div class="flex items-center gap-2 mt-3">
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">
                            ${animal.animal_class}
                        </span>
                        ${animal.is_endangered ? '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">En peligro</span>' : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    function getAnimalEmoji(animalClass) {
        const emojis = {
            'Mamífero': '<img src="https://img.icons8.com/windows/32/lion.png" class="inline-block w-10 h-10" alt="mamífero"/>',
            'Ave': '<img src="https://img.icons8.com/windows/32/eagle.png" class="inline-block w-10 h-10" alt="ave"/>',
            'Reptil': '<img src="https://img.icons8.com/windows/32/crocodile.png" class="inline-block w-10 h-10" alt="reptil"/>',
            'Anfibio': '<img src="https://img.icons8.com/windows/32/frog.png" class="inline-block w-10 h-10" alt="anfibio"/>',
            'Pez': '<img src="https://img.icons8.com/windows/32/fish.png" class="inline-block w-10 h-10" alt="pez"/>',
            'Invertebrado': '<img src="https://img.icons8.com/windows/32/butterfly.png" class="inline-block w-10 h-10" alt="invertebrado"/>'
        };
        return emojis[animalClass] || '<img src="https://img.icons8.com/windows/32/paw-print.png" class="inline-block w-10 h-10" alt="otro"/>';
    }
    
    // Mapeo de códigos de clase a etiquetas españolas
    function classCodeToSpanish(code) {
        const classMap = {
            'MAMMAL': 'Mamífero',
            'BIRD': 'Ave',
            'REPTILE': 'Reptil',
            'AMPHIBIAN': 'Anfibio',
            'FISH': 'Pez',
            'INVERTEBRATE': 'Invertebrado'
        };
        return classMap[code] || code;
    }
    
    function viewAnimal(animalId) {
        window.location.href = `/animal/${animalId}/`;
    }
    
    // Search functionality
    document.getElementById('search-input').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        filteredAnimals = allAnimals.filter(animal => 
            animal.name.toLowerCase().includes(query) ||
            animal.scientific_name.toLowerCase().includes(query) ||
            animal.description.toLowerCase().includes(query)
        );
        renderAnimals();
    });
    
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Update active state
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active', 'bg-purple-600', 'text-white');
                b.classList.add('bg-gray-100', 'text-gray-700');
            });
            btn.classList.add('active', 'bg-purple-600', 'text-white');
            btn.classList.remove('bg-gray-100', 'text-gray-700');
            
            // Filter animals
            const filterClass = btn.dataset.class;
            if (filterClass === 'all') {
                filteredAnimals = [...allAnimals];
            } else {
                const filterSpanish = classCodeToSpanish(filterClass);
                filteredAnimals = allAnimals.filter(animal => 
                    animal.animal_class === filterSpanish
                );
            }
            renderAnimals();
        });
    });
</script>
{% endblock %}
