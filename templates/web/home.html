{% extends 'base.html' %}

{% block title %}Animal Recognition - Inicio{% endblock %}

{% block content %}
<!-- Analyzing Overlay -->
<div id="analyzing-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center">
    <div class="bg-white bg-opacity-95 rounded-3xl p-8 text-center max-w-sm mx-4 shadow-2xl">
        <div class="relative w-24 h-24 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-purple-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-purple-600 rounded-full border-t-transparent animate-spin" style="animation-duration: 1.5s;"></div>
            <div class="absolute inset-3 border-4 border-green-200 rounded-full"></div>
            <div class="absolute inset-3 border-4 border-green-500 rounded-full border-b-transparent animate-spin" style="animation-direction: reverse; animation-duration: 1s;"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-3xl animate-pulse">üîç</span>
            </div>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Analizando imagen...</h3>
        <p class="text-gray-500" id="analyzing-status">Procesando imagen</p>
        <!-- Progress bar -->
        <div class="mt-4 w-full bg-gray-200 rounded-full h-2">
            <div id="analyzing-progress" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="text-sm text-gray-400 mt-2" id="analyzing-step">Paso 1 de 4</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Recognition Section -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl card-shadow overflow-hidden">
            <!-- Mode Selector Tabs -->
            <div class="flex border-b">
                <button id="tab-camera" class="flex-1 py-4 px-6 text-center font-semibold transition bg-purple-600 text-white">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        C√°mara en Tiempo Real
                    </span>
                </button>
                <button id="tab-upload" class="flex-1 py-4 px-6 text-center font-semibold transition bg-gray-100 text-gray-600 hover:bg-gray-200">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Subir Foto
                    </span>
                </button>
            </div>
            
            <!-- Camera Mode -->
            <div id="camera-mode" class="block">
                <div class="relative bg-gray-900 aspect-video">
                    <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                    <canvas id="overlay-canvas" class="camera-overlay"></canvas>
                    
                    <!-- Camera Controls -->
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-4">
                        <button id="start-camera-btn" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-full font-semibold shadow-lg transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            Iniciar C√°mara
                        </button>
                        <button id="stop-camera-btn" class="hidden px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-full font-semibold shadow-lg transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                            </svg>
                            Detener
                        </button>
                    </div>
                    
                    <!-- Connection Status -->
                    <div id="connection-status" class="absolute top-4 right-4 px-3 py-1 rounded-full text-sm font-medium bg-gray-700 text-gray-300">
                        ‚ö™ Desconectado
                    </div>

                    <!-- Live Analyzing Indicator -->
                    <div id="live-analyzing" class="hidden absolute top-4 left-4 px-4 py-2 rounded-full bg-black bg-opacity-50 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                            <span class="text-white text-sm font-medium">Analizando...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload Mode -->
            <div id="upload-mode" class="hidden">
                <!-- Empty state / Upload zone -->
                <div id="upload-zone" class="aspect-video bg-gray-100 flex flex-col items-center justify-center p-8">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-4 bg-purple-100 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Arrastra una imagen aqu√≠</h3>
                        <p class="text-gray-500 mb-4">o haz clic para seleccionar</p>
                        <label for="photo-upload" class="cursor-pointer inline-flex items-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-semibold transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Seleccionar Imagen
                        </label>
                        <input type="file" id="photo-upload" accept="image/*" class="hidden">
                    </div>
                </div>
                
                <!-- Image preview -->
                <div id="preview-zone" class="hidden">
                    <div class="relative aspect-video bg-gray-900">
                        <img id="preview-image" class="w-full h-full object-contain" alt="Imagen cargada">
                        <button id="clear-upload-btn" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 bg-gray-50">
                        <button id="analyze-photo-btn" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold text-lg transition flex items-center justify-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            Analizar Imagen
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Recognition Result -->
            <div id="recognition-result" class="hidden p-6 border-t">
                <div class="flex items-start gap-4">
                    <div class="w-20 h-20 rounded-xl bg-gray-100 flex items-center justify-center text-4xl" id="result-emoji">
                        ü¶Å
                    </div>
                    <div class="flex-1">
                        <h3 id="result-name" class="text-2xl font-bold text-gray-800">Le√≥n</h3>
                        <p id="result-scientific" class="text-gray-500 italic">Panthera leo</p>
                        <div class="mt-2 flex items-center gap-2">
                            <span class="text-sm text-gray-600">Confianza:</span>
                            <div class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div id="confidence-bar" class="h-full bg-green-500 confidence-bar" style="width: 95%"></div>
                            </div>
                            <span id="confidence-text" class="text-sm font-semibold text-green-600">95%</span>
                        </div>
                    </div>
                    <button id="view-details-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition">
                        Ver m√°s ‚Üí
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="mt-6 bg-white rounded-2xl card-shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üìñ C√≥mo usar</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold">1</div>
                    <div>
                        <h3 class="font-semibold text-gray-800">Activa la c√°mara</h3>
                        <p class="text-sm text-gray-600">Haz clic en "Iniciar C√°mara"</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold">2</div>
                    <div>
                        <h3 class="font-semibold text-gray-800">Enfoca al animal</h3>
                        <p class="text-sm text-gray-600">Apunta hacia el animal que quieras identificar</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold">3</div>
                    <div>
                        <h3 class="font-semibold text-gray-800">Aprende</h3>
                        <p class="text-sm text-gray-600">Descubre informaci√≥n fascinante</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Discoveries Sidebar -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl card-shadow overflow-hidden sticky top-8">
            <div class="p-6 bg-gradient-to-r from-yellow-400 to-orange-500 text-white">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    üèÜ Mis Descubrimientos
                </h2>
                <p class="text-yellow-100 mt-1">
                    <span id="discovery-count">0</span> animales encontrados
                </p>
            </div>
            
            <div id="discoveries-list" class="p-4 max-h-96 overflow-y-auto">
                <!-- Empty state -->
                <div id="empty-discoveries" class="text-center py-8">
                    <div class="text-6xl mb-4">üîç</div>
                    <p class="text-gray-500">A√∫n no has descubierto ning√∫n animal</p>
                    <p class="text-sm text-gray-400 mt-2">¬°Inicia la c√°mara y comienza a explorar!</p>
                </div>
                
                <!-- Discovery items will be added here -->
            </div>
            
            <div class="p-4 border-t bg-gray-50">
                <a href="{% url 'gallery' %}" class="block text-center text-purple-600 hover:text-purple-700 font-medium">
                    Ver galer√≠a completa ‚Üí
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Animal Info Modal -->
<div id="animal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-start mb-4">
                <h2 id="modal-name" class="text-3xl font-bold text-gray-800">Le√≥n</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p id="modal-scientific" class="text-gray-500 italic mb-4">Panthera leo</p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 rounded-xl p-4">
                    <span class="text-gray-500 text-sm">Clase</span>
                    <p id="modal-class" class="font-semibold text-gray-800">Mam√≠fero</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                    <span class="text-gray-500 text-sm">Dieta</span>
                    <p id="modal-diet" class="font-semibold text-gray-800">Carn√≠voro</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                    <span class="text-gray-500 text-sm">H√°bitat</span>
                    <p id="modal-habitat" class="font-semibold text-gray-800">Sabana africana</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                    <span class="text-gray-500 text-sm">Estado</span>
                    <p id="modal-status" class="font-semibold text-gray-800">Vulnerable</p>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-bold text-gray-800 mb-2">Descripci√≥n</h3>
                <p id="modal-description" class="text-gray-600">
                    El le√≥n es un mam√≠fero carn√≠voro de la familia de los f√©lidos...
                </p>
            </div>
            
            <div class="bg-yellow-50 rounded-xl p-4">
                <h3 class="font-bold text-yellow-800 mb-2">üí° Dato curioso</h3>
                <p id="modal-fun-fact" class="text-yellow-700">
                    Los leones son los √∫nicos felinos que viven en grupos llamados manadas.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // WebSocket connection
    let socket = null;
    let sessionId = null;
    let isStreaming = false;
    let discoveries = [];
    let currentAnimal = null;
    
    // DOM Elements
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('overlay-canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('start-camera-btn');
    const stopBtn = document.getElementById('stop-camera-btn');
    const connectionStatus = document.getElementById('connection-status');
    const recognitionResult = document.getElementById('recognition-result');
    const discoveriesList = document.getElementById('discoveries-list');
    const discoveryCount = document.getElementById('discovery-count');
    const emptyDiscoveries = document.getElementById('empty-discoveries');
    const analyzingOverlay = document.getElementById('analyzing-overlay');
    const liveAnalyzing = document.getElementById('live-analyzing');
    
    // Tab elements
    const tabCamera = document.getElementById('tab-camera');
    const tabUpload = document.getElementById('tab-upload');
    const cameraMode = document.getElementById('camera-mode');
    const uploadMode = document.getElementById('upload-mode');
    const uploadZone = document.getElementById('upload-zone');
    const previewZone = document.getElementById('preview-zone');
    
    // Photo upload elements
    const photoUpload = document.getElementById('photo-upload');
    const previewImage = document.getElementById('preview-image');
    const clearUploadBtn = document.getElementById('clear-upload-btn');
    const analyzePhotoBtn = document.getElementById('analyze-photo-btn');
    
    // WebSocket URL
    const wsUrl = `ws://${window.location.host}/ws/recognition/`;
    
    // Tab switching
    tabCamera.addEventListener('click', () => {
        switchToCamera();
    });
    
    tabUpload.addEventListener('click', () => {
        switchToUpload();
    });
    
    function switchToCamera() {
        tabCamera.classList.remove('bg-gray-100', 'text-gray-600');
        tabCamera.classList.add('bg-purple-600', 'text-white');
        tabUpload.classList.remove('bg-purple-600', 'text-white');
        tabUpload.classList.add('bg-gray-100', 'text-gray-600');
        cameraMode.classList.remove('hidden');
        uploadMode.classList.add('hidden');
    }
    
    function switchToUpload() {
        // Stop camera when switching to upload
        stopCamera();
        
        tabUpload.classList.remove('bg-gray-100', 'text-gray-600');
        tabUpload.classList.add('bg-purple-600', 'text-white');
        tabCamera.classList.remove('bg-purple-600', 'text-white');
        tabCamera.classList.add('bg-gray-100', 'text-gray-600');
        uploadMode.classList.remove('hidden');
        cameraMode.classList.add('hidden');
    }
    
    // Drag and drop handling
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('bg-purple-50', 'border-2', 'border-dashed', 'border-purple-400');
    });
    
    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('bg-purple-50', 'border-2', 'border-dashed', 'border-purple-400');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('bg-purple-50', 'border-2', 'border-dashed', 'border-purple-400');
        
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            handleImageFile(file);
        }
    });
    
    // Photo upload handling
    photoUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleImageFile(file);
        }
    });
    
    function handleImageFile(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            previewImage.src = event.target.result;
            uploadZone.classList.add('hidden');
            previewZone.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
    
    clearUploadBtn.addEventListener('click', () => {
        previewZone.classList.add('hidden');
        uploadZone.classList.remove('hidden');
        photoUpload.value = '';
        previewImage.src = '';
    });
    
    analyzePhotoBtn.addEventListener('click', async () => {
        const imageData = previewImage.src;
        if (!imageData) return;
        
        // Show analyzing overlay with progress
        showAnalyzingOverlay();
        
        // Simulate 5 second analysis with progress updates
        const steps = [
            { progress: 20, status: 'Procesando imagen...', step: 'Paso 1 de 4' },
            { progress: 45, status: 'Detectando patrones...', step: 'Paso 2 de 4' },
            { progress: 70, status: 'Identificando especie...', step: 'Paso 3 de 4' },
            { progress: 90, status: 'Obteniendo informaci√≥n...', step: 'Paso 4 de 4' },
        ];
        
        let stepIndex = 0;
        const progressBar = document.getElementById('analyzing-progress');
        const statusText = document.getElementById('analyzing-status');
        const stepText = document.getElementById('analyzing-step');
        
        const progressInterval = setInterval(() => {
            if (stepIndex < steps.length) {
                progressBar.style.width = steps[stepIndex].progress + '%';
                statusText.textContent = steps[stepIndex].status;
                stepText.textContent = steps[stepIndex].step;
                stepIndex++;
            }
        }, 1000);
        
        try {
            // Wait minimum 5 seconds
            const [response] = await Promise.all([
                fetch('/api/recognize/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                }),
                new Promise(resolve => setTimeout(resolve, 5000))
            ]);
            
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            statusText.textContent = '¬°Animal encontrado!';
            stepText.textContent = 'Completado';
            
            const data = await response.json();
            
            // Small delay to show 100%
            await new Promise(resolve => setTimeout(resolve, 500));
            
            hideAnalyzingOverlay();
            
            if (data.success && data.animal) {
                currentAnimal = data.animal;
                showRecognitionResult({ recognition: data.recognition, animal: data.animal });
                
                // Auto redirect after showing result
                setTimeout(() => {
                    window.location.href = `/animal/${data.animal.id}/`;
                }, 2000);
            } else {
                showNotification('No se detect√≥ ning√∫n animal üòï', 'warning');
            }
        } catch (error) {
            clearInterval(progressInterval);
            console.error('Error analyzing photo:', error);
            hideAnalyzingOverlay();
            showNotification('Error al analizar la imagen', 'error');
        }
    });
    
    function showAnalyzingOverlay() {
        // Reset progress
        document.getElementById('analyzing-progress').style.width = '0%';
        document.getElementById('analyzing-status').textContent = 'Iniciando an√°lisis...';
        document.getElementById('analyzing-step').textContent = 'Preparando...';
        analyzingOverlay.classList.remove('hidden');
    }
    
    function hideAnalyzingOverlay() {
        analyzingOverlay.classList.add('hidden');
    }
    
    // Start camera and WebSocket
    startBtn.addEventListener('click', async () => {
        try {
            // Request camera access
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: 640, height: 480 }
            });
            video.srcObject = stream;
            
            // Connect WebSocket
            connectWebSocket();
            
            // Update UI
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('No se pudo acceder a la c√°mara. Por favor, permite el acceso.');
        }
    });
    
    // Stop camera
    stopBtn.addEventListener('click', () => {
        stopCamera();
    });
    
    function stopCamera() {
        // Stop video stream
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        
        // Disconnect WebSocket
        if (socket) {
            socket.close();
            socket = null;
        }
        
        isStreaming = false;
        liveAnalyzing.classList.add('hidden');
        
        // Update UI
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        connectionStatus.innerHTML = '‚ö™ Desconectado';
        connectionStatus.className = 'absolute top-4 right-4 px-3 py-1 rounded-full text-sm font-medium bg-gray-700 text-gray-300';
    }
    
    function connectWebSocket() {
        socket = new WebSocket(wsUrl);
        
        socket.onopen = () => {
            console.log('WebSocket connected');
            connectionStatus.innerHTML = 'üü¢ Conectado';
            connectionStatus.className = 'absolute top-4 right-4 px-3 py-1 rounded-full text-sm font-medium bg-green-600 text-white';
            
            // Start sending frames
            isStreaming = true;
            sendFrames();
        };
        
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleMessage(data);
        };
        
        socket.onclose = () => {
            console.log('WebSocket disconnected');
            connectionStatus.innerHTML = 'üî¥ Desconectado';
            connectionStatus.className = 'absolute top-4 right-4 px-3 py-1 rounded-full text-sm font-medium bg-red-600 text-white';
            isStreaming = false;
        };
        
        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
        };
    }
    
    function sendFrames() {
        if (!isStreaming || !socket || socket.readyState !== WebSocket.OPEN) {
            return;
        }
        
        // Show live analyzing indicator
        liveAnalyzing.classList.remove('hidden');
        
        // Capture frame from video
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 640;
        tempCanvas.height = 480;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(video, 0, 0, 640, 480);
        
        // Convert to base64
        const frameData = tempCanvas.toDataURL('image/jpeg', 0.8);
        
        // Send to server
        socket.send(JSON.stringify({
            type: 'frame',
            data: frameData
        }));
        
        // Schedule next frame (5 fps)
        setTimeout(sendFrames, 200);
    }
    
    function handleMessage(data) {
        switch (data.type) {
            case 'session_started':
                sessionId = data.data.id;
                console.log('Session started:', sessionId);
                break;
                
            case 'recognition':
                showRecognitionResult(data.data);
                break;
                
            case 'discovery':
                addDiscovery(data.data);
                break;
                
            case 'discoveries':
                updateDiscoveriesList(data.data);
                break;
                
            case 'error':
                console.error('Server error:', data.data.message);
                break;
        }
    }
    
    function showRecognitionResult(data) {
        const { recognition, animal } = data;
        
        currentAnimal = animal;
        recognitionResult.classList.remove('hidden');
        liveAnalyzing.classList.add('hidden');
        
        document.getElementById('result-name').textContent = animal.name;
        document.getElementById('result-scientific').textContent = animal.scientific_name;
        
        const confidence = recognition.confidence * 100;
        document.getElementById('confidence-bar').style.width = `${confidence}%`;
        document.getElementById('confidence-text').textContent = `${confidence.toFixed(1)}%`;
        
        // Store current animal for modal
        recognitionResult.dataset.animal = JSON.stringify(animal);
        
        // Show success notification
        showNotification(`¬°${animal.name} detectado! üéâ`, 'success');
    }
    
    function addDiscovery(discovery) {
        // Check if already exists
        if (discoveries.some(d => d.animal_id === discovery.animal_id)) {
            return;
        }
        
        discoveries.push(discovery);
        updateDiscoveryUI();
        
        // Show notification
        showNotification(`¬°Nuevo descubrimiento! üéâ`);
    }
    
    function updateDiscoveryUI() {
        discoveryCount.textContent = discoveries.length;
        
        if (discoveries.length > 0) {
            emptyDiscoveries.classList.add('hidden');
        }
        
        // Add discovery cards
        discoveries.forEach((discovery, index) => {
            if (!document.getElementById(`discovery-${discovery.id}`)) {
                const card = document.createElement('div');
                card.id = `discovery-${discovery.id}`;
                card.className = 'discovery-card bg-gray-50 rounded-xl p-3 mb-3 flex items-center gap-3';
                card.innerHTML = `
                    <img src="${discovery.thumbnail_url}" alt="" class="w-16 h-16 rounded-lg object-cover bg-gray-200">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${discovery.animal_name || 'Animal'}</h4>
                        <p class="text-xs text-gray-500">${new Date(discovery.discovered_at).toLocaleTimeString()}</p>
                    </div>
                `;
                discoveriesList.insertBefore(card, emptyDiscoveries);
            }
        });
    }
    
    function updateDiscoveriesList(data) {
        discoveries = data.map(d => d.discovery);
        updateDiscoveryUI();
    }
    
    function showNotification(message, type = 'success') {
        const colors = {
            success: 'bg-green-500',
            warning: 'bg-yellow-500',
            error: 'bg-red-500'
        };
        
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 3000);
    }
    
    // Modal handling - redirect to animal info page
    document.getElementById('view-details-btn')?.addEventListener('click', () => {
        if (currentAnimal && currentAnimal.id) {
            window.location.href = `/animal/${currentAnimal.id}/`;
        }
    });
    
    document.getElementById('close-modal-btn')?.addEventListener('click', () => {
        document.getElementById('animal-modal').classList.add('hidden');
    });
    
    function showAnimalModal(animal) {
        document.getElementById('modal-name').textContent = animal.name;
        document.getElementById('modal-scientific').textContent = animal.scientific_name;
        document.getElementById('modal-class').textContent = animal.animal_class;
        document.getElementById('modal-diet').textContent = animal.diet;
        document.getElementById('modal-habitat').textContent = animal.habitat;
        document.getElementById('modal-status').textContent = animal.conservation_status;
        document.getElementById('modal-description').textContent = animal.description;
        document.getElementById('modal-fun-fact').textContent = animal.fun_facts?.[0] || 'Sin datos curiosos disponibles';
        
        document.getElementById('animal-modal').classList.remove('hidden');
    }
    
    // Close modal on outside click
    document.getElementById('animal-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'animal-modal') {
            document.getElementById('animal-modal').classList.add('hidden');
        }
    });
</script>
{% endblock %}
